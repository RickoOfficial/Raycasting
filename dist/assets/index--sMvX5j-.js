var N=Object.defineProperty;var j=(e,t,s)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var r=(e,t,s)=>j(e,typeof t!="symbol"?t+"":t,s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function s(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=s(n);fetch(n.href,o)}})();class d{static on(t,s){this.events[t]||(this.events[t]=[]),this.events[t].push(s)}static off(t,s){if(!this.events[t])return;const i=this.events[t].indexOf(s);i>-1&&this.events[t].splice(i,1)}static emit(t,...s){this.events[t]&&this.events[t].forEach(i=>i(...s))}}r(d,"events",{});window.Events=d;class h{constructor(t,s){r(this,"x");r(this,"y");t instanceof h?(this.x=t.x,this.y=t.y):(this.x=t??0,this.y=s??0)}rotate(t){const s=this.x*Math.cos(t)-this.y*Math.sin(t),i=this.x*Math.sin(t)+this.y*Math.cos(t);return this.x=s,this.y=i,this}rotateDegrees(t){const s=t*Math.PI/180,i=this.x*Math.cos(s)-this.y*Math.sin(s),n=this.x*Math.sin(s)+this.y*Math.cos(s);return this.x=i,this.y=n,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return t!==0&&(this.x/=t,this.y/=t),this}angle(){return Math.atan2(this.y,this.x)}angleDegrees(){return this.angle()*(180/Math.PI)}static fromAngle(t){return new h(Math.cos(t),Math.sin(t))}static fromAngleDegrees(t){return this.fromAngle(t*(Math.PI/180))}dist(t,s){let i=0;return t instanceof h&&(i=t.copy().sub(this).length()),typeof t=="number"&&(i=new h(t,s).sub(this).length()),i}add(t,s){return t instanceof h&&(this.x+=t.x,this.y+=t.y),typeof t=="number"&&(this.x+=t,this.y+=s??t),this}sub(t,s){return t instanceof h&&(this.x-=t.x,this.y-=t.y),typeof t=="number"&&(this.x-=t,this.y-=s??t),this}div(t,s){return t instanceof h&&(this.x/=t.x,this.y/=t.y),typeof t=="number"&&(this.x/=t,this.y/=s??t),this}mult(t,s){return t instanceof h&&(this.x*=t.x,this.y*=t.y),typeof t=="number"&&(this.x*=t,this.y*=s??t),this}set(t,s){return t instanceof h&&(this.x=t.x,this.y=t.y),typeof t=="number"&&(this.x=t,this.y=s??t),this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}equals(t){return this.x===t.x&&this.y===t.y}array(){return[this.x,this.y]}copy(){return new h(this.x,this.y)}isInBounds(t,s){return this.x>=t.x&&this.x<=s.x&&this.y>=t.y&&this.y<=s.y}valueOf(){return this.array()}toString(){return this.array().toString()}}const m=document.getElementById("canvas");m.width=window.innerWidth;m.height=window.innerHeight;window.addEventListener("resize",()=>{m.width=window.innerWidth,m.height=window.innerHeight});const f=m.getContext("2d"),M=()=>new h(m.width,m.height),G=(()=>{const e=new h(0,0);return d.on("mousemove",t=>{e.set(t.clientX,t.clientY)}),()=>e.copy()})();window.addEventListener("keydown",e=>{d.emit("keydown",e)}),window.addEventListener("keyup",e=>{d.emit("keyup",e)}),window.addEventListener("mousemove",e=>{d.emit("mousemove",e)}),window.addEventListener("contextmenu",e=>{d.emit("contextmenu",e)});const T=1e-6,K=e=>e.copy().sub(...F.array()).div(...b.copy().div(P,W).array()),O=(e,t)=>t>0?Math.ceil(e+Math.sign(t)*T):t<0?Math.floor(e+Math.sign(t)*T):e,Z=(e,t,s,i,n,o=!1)=>{const l=(e-t)/(s-t)*(n-i)+i;return o?Math.min(Math.max(l,i),n):l};class J{static number(t=1,s){return s||(s=t,t=0),Math.random()*(s-t+1)+t}static string(t=8,s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"){let i="";if(s instanceof Array){for(let n of s)i+=n[Math.round(this.number(0,n.length-1))];for(let n=i.length;n<t;n++){const o=this.fromArray(s);i+=o[Math.round(this.number(0,o.length-1))]}i=this.shuffle(i)}if(typeof s=="string"){const n=s.split("");for(let o=0;o<t;o++)i+=this.fromArray(n)}return i.slice(0,t)}static fromArray(t){return t[Math.round(this.number(0,t.length-1))]}static shuffle(t){return t instanceof Array?t.map(s=>s).sort(()=>this.number(-1,1)):typeof t=="string"?t.split("").sort(()=>this.number(-1,1)).join(""):t}}const S=class S{constructor(t,s){r(this,"pos");r(this,"size");this.pos=t,this.size=s,S.arrayOfGameObjects.push(this)}getPos(){return this.pos.copy()}getSize(){return this.size.copy()}};r(S,"arrayOfGameObjects",[]);let A=S;var a=(e=>(e[e.EMPTY=0]="EMPTY",e[e.WALL=1]="WALL",e))(a||{}),v=(e=>(e.EMPTY="#243a3c",e.WALL="#24282c",e))(v||{});class H extends A{constructor(s,i,n=0){super(s,i);r(this,"type");r(this,"color");this.type=n,this.color=v[a[this.type]],this.attachEvents()}attachEvents(){}draw(s){s.fillStyle=this.color,s.strokeStyle="#0003",s.lineWidth=.03,Y(s,this.pos.x,this.pos.y,this.size.x,this.size.y),s.fill(),s.stroke()}update(...s){[...s]}changeType(s){this.type=s,this.color=v[a[this.type]]}}const P=10,W=10,b=new h(M().y,M().y).div(4),F=new h(16,16),g=class g{constructor(t,s){r(this,"COLS");r(this,"ROWS");r(this,"map",[]);r(this,"pos",new h(0,0));r(this,"size",new h(0,0));this.COLS=t,this.ROWS=s,g.instance=this,this.attachEvents(),this.fillWorld()}attachEvents(){d.on("contextmenu",t=>{t.preventDefault();const s=g.getCell(...K(G()).floor().array());s&&s.changeType(s.type===a.EMPTY?a.WALL:a.EMPTY)})}getCell(t,s){try{return this.map[s][t]}catch{return null}}static getCell(t,s){return g.instance.getCell(t,s)}fillWorld(){for(let t=0;t<this.ROWS;t++){this.map[t]=[];for(let s=0;s<this.COLS;s++){let i=a.EMPTY;t===0||t===this.ROWS-1||s===0||s===this.COLS-1?i=a.WALL:s==1&&t==1||(i=J.fromArray([a.EMPTY,a.EMPTY,a.EMPTY,a.EMPTY,a.EMPTY,a.EMPTY,a.EMPTY,a.EMPTY,a.WALL,a.WALL])),this.map[t][s]=new H(new h(s,t),new h(1,1),i)}}}draw(t){t.fillStyle="#181818",Y(t,...this.pos.array(),...this.size.array()),t.fill(),R(t);for(let s=0;s<this.ROWS;s++)for(let i=0;i<this.COLS;i++)this.map[s][i].draw(t);k(t)}update(){}};r(g,"instance");let p=g;const R=e=>{e.translate(...F.array()),e.scale(...b.copy().div(P,W).array())},k=e=>{e.resetTransform()},x=(e,t,s,i,n,o=!0)=>{o&&e.beginPath(),e.moveTo(t,s),e.lineTo(i,n),o&&e.closePath()},Y=(e,t,s,i,n,o=!0)=>{o&&e.beginPath(),e.rect(t,s,i,n),o&&e.closePath()},z=(e,t,s,i,n=!0)=>{n&&e.beginPath(),e.arc(t,s,i,0,2*Math.PI),n&&e.closePath()};class I{constructor(t,s){r(this,"initialPos");r(this,"initialDir");r(this,"pos");r(this,"dir");r(this,"dots",[]);this.initialPos=t.copy(),this.initialDir=s.copy().normalize().mult(T),this.pos=this.initialPos.copy(),this.dir=this.initialDir.copy().add(this.initialPos)}next(){const t=new h(...this.dir.array()),s=this.dir.copy().sub(this.pos);if(s.x!==0){const i=s.y/s.x,n=this.pos.y-i*this.pos.x,o=O(this.dir.x,s.x),u=o*i+n;if(t.set(o,u),i!==0){const l=O(this.dir.y,s.y),y=(l-n)/i;this.dir.dist(y,l)<this.dir.dist(t)&&t.set(y,l)}}else{const i=O(this.dir.y,s.y),n=this.dir.x;t.set(n,i)}return this.dots.push(t),this.pos.set(t),this.dir.set(t).add(this.initialDir),t.add(this.initialDir.copy().mult(-2))}prev(){return this.dots[this.dots.length-2].copy()}}const E=class E extends A{constructor(s,i){super(s,i);r(this,"viewAngle",new h(1,1));r(this,"raysDots",[]);r(this,"raysDotsOnWall",[]);r(this,"FOV",60);r(this,"FOVRayCount",180);r(this,"FOVRayStep",Math.abs((-this.FOV/2-this.FOV/2)/this.FOVRayCount));r(this,"FOVRayWidth",M().x/this.FOVRayCount);r(this,"mousePos",new h(0,0));r(this,"prevMousePos",new h(0,0));r(this,"keys",{});r(this,"rotateSpeed",3);r(this,"moveSpeed",.05);r(this,"mouseSensitivity",.3);r(this,"mouseControlled",!1);E.players.push(this),this.attachEvents()}toggleMouseControl(){this.mouseControlled=!this.mouseControlled}attachEvents(){d.on("keydown",s=>{this.keys[s.key.toLowerCase()]=!0}),d.on("keyup",s=>{this.keys[s.key.toLowerCase()]=!1}),d.on("mousemove",s=>{this.prevMousePos.equals(new h)&&this.prevMousePos.set(s.clientX,s.clientY),this.mousePos.set(s.clientX,s.clientY)})}draw(s){const i=M().y-b.y-32;for(let n=0;n<=this.FOVRayCount;n++){const o=this.raysDotsOnWall[n],u=this.pos.dist(o),l=Z(u,0,new h(0,0).dist(P,W),-i,0)*-1,y=(M().y-l)/2;s.fillStyle=`rgba(255, 0, 0, ${l/i})`,s.beginPath(),Y(s,n*this.FOVRayWidth-1,y,this.FOVRayWidth+1,l),s.fill()}}drawOnMinimap(s){R(s),s.fillStyle="#f0f",z(s,...this.pos.array(),this.size.x),s.fill(),s.strokeStyle="#fff",s.lineWidth=.01,x(s,...this.pos.array(),...this.pos.copy().add(this.viewAngle).array()),s.stroke(),this.drawFOV(s),k(s)}drawFOV(s){if(this.raysDotsOnWall.length>0){s.fillStyle="#0f0",s.beginPath(),x(s,...this.pos.array(),...this.raysDotsOnWall[0].array(),!1);for(let i=1;i<this.raysDotsOnWall.length;i++)x(s,...this.raysDotsOnWall[i-1].array(),...this.raysDotsOnWall[i].array(),!1);x(s,...this.raysDotsOnWall.at(-1).array(),...this.pos.array(),!1),s.closePath(),s.stroke()}}update(){var s,i,n,o,u;(this.keys.a||this.keys.ф)&&this.viewAngle.rotateDegrees(-this.rotateSpeed),(this.keys.d||this.keys.в)&&this.viewAngle.rotateDegrees(this.rotateSpeed),this.mouseControlled&&(this.viewAngle.rotateDegrees((this.mousePos.x-this.prevMousePos.x)*this.mouseSensitivity),this.prevMousePos.set(...this.mousePos.array()));{if(this.keys.w||this.keys.ц){const{x:l,y}=this.pos.copy().add(this.viewAngle.copy().mult(this.moveSpeed));((s=p.getCell(Math.floor(l),Math.floor(this.pos.y)))==null?void 0:s.type)!==a.WALL&&(this.pos.x=l),((i=p.getCell(Math.floor(this.pos.x),Math.floor(y)))==null?void 0:i.type)!==a.WALL&&(this.pos.y=y)}if(this.keys.s||this.keys.ы){const{x:l,y}=this.pos.copy().add(this.viewAngle.copy().rotateDegrees(180).mult(this.moveSpeed));((n=p.getCell(Math.floor(l),Math.floor(this.pos.y)))==null?void 0:n.type)!==a.WALL&&(this.pos.x=l),((o=p.getCell(Math.floor(this.pos.x),Math.floor(y)))==null?void 0:o.type)!==a.WALL&&(this.pos.y=y)}((u=p.getCell(...this.pos.copy().floor().array()))==null?void 0:u.type)==a.WALL&&this.pullOutFromWall()}this.raysDots=[],this.raysDotsOnWall=[];for(let l=-this.FOV/2;l<this.FOV/2;l+=this.FOVRayStep){const y=new I(this.pos,this.viewAngle.copy().rotateDegrees(l));for(;;){if(this.raysDots.length+this.raysDotsOnWall.length>=Number.MAX_SAFE_INTEGER)throw new Error("Too many rays");const L=y.next();if(L.isInBounds(new h(0,0),new h(P,W))===!1)break;const w=p.getCell(...L.copy().floor().array());if(w instanceof H?w.type===a.WALL:!1){this.raysDots.at(-1)instanceof h&&this.raysDotsOnWall.push(this.raysDots.at(-1));break}this.raysDots.push(L)}}}pullOutFromWall(){var l;const s=[],i=[];for(let y=0;y<360;y+=360/36){const L=new I(this.pos,h.fromAngleDegrees(y));for(let C=0;C<10;C++){const w=L.next().add(h.fromAngle(y).div(10));((l=p.getCell(...w.copy().floor().array()))==null?void 0:l.type)===a.EMPTY&&(s.push(w),i.push(w.dist(this.pos)))}}R(f),f.fillStyle="#f00",f.beginPath();for(let y=0;y<s.length;y++)z(f,...s[y].array(),.03),f.fill();f.closePath(),k(f);const n=Math.min(...i),o=i.indexOf(n),u=s[o];this.pos.set(u)}};r(E,"players",[]);let c=E;window.Player=c;const D=new p(P,W);D.pos=F;D.size=b;new c(new h(1.5,1.5),new h(.2));let V=0,B=0;const q=e=>{if(e){const t=e-V;V=e,B=1e3/t}f.fillStyle="#333",f.fillRect(0,0,...M().array()),D.update();for(let t=0;t<c.players.length;t++)c.players[t].update(),c.players[t].draw(f);D.draw(f);for(let t=0;t<c.players.length;t++)c.players[t].drawOnMinimap(f);f.font="16px monospace",f.fillStyle="#fff",f.fillText(Math.round(B).toString(),16,16),requestAnimationFrame(q)};q();
