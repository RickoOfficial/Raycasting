var V=Object.defineProperty;var j=(i,t,s)=>t in i?V(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s;var o=(i,t,s)=>j(i,typeof t!="symbol"?t+"":t,s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const p of r.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&e(p)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();class u{static on(t,s){this.events[t]||(this.events[t]=[]),this.events[t].push(s)}static off(t,s){if(!this.events[t])return;const e=this.events[t].indexOf(s);e>-1&&this.events[t].splice(e,1)}static emit(t,...s){this.events[t]&&this.events[t].forEach(e=>e(...s))}}o(u,"events",{});window.Events=u;class h{constructor(t,s){o(this,"x");o(this,"y");t instanceof h?(this.x=t.x,this.y=t.y):(this.x=t??0,this.y=s??0)}rotate(t){const s=this.x*Math.cos(t)-this.y*Math.sin(t),e=this.x*Math.sin(t)+this.y*Math.cos(t);return this.x=s,this.y=e,this}rotateDegrees(t){const s=t*Math.PI/180,e=this.x*Math.cos(s)-this.y*Math.sin(s),n=this.x*Math.sin(s)+this.y*Math.cos(s);return this.x=e,this.y=n,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return t!==0&&(this.x/=t,this.y/=t),this}angle(){return Math.atan2(this.y,this.x)}angleDegrees(){return this.angle()*(180/Math.PI)}static fromAngle(t){return new h(Math.cos(t),Math.sin(t))}static fromAngleDegrees(t){return this.fromAngle(t*(Math.PI/180))}dist(t,s){let e=0;return t instanceof h&&(e=t.copy().sub(this.copy()).length()),typeof t=="number"&&(e=new h(t,s).sub(this.copy()).length()),e}add(t,s){return t instanceof h&&(this.x+=t.x,this.y+=t.y),typeof t=="number"&&(this.x+=t,this.y+=s??t),this}sub(t,s){return t instanceof h&&(this.x-=t.x,this.y-=t.y),typeof t=="number"&&(this.x-=t,this.y-=s??t),this}div(t,s){return t instanceof h&&(this.x/=t.x,this.y/=t.y),typeof t=="number"&&(this.x/=t,this.y/=s??t),this}mult(t,s){return t instanceof h&&(this.x*=t.x,this.y*=t.y),typeof t=="number"&&(this.x*=t,this.y*=s??t),this}set(t,s){return t instanceof h&&(this.x=t.x,this.y=t.y),typeof t=="number"&&(this.x=t,this.y=s??t),this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}equals(t){return this.x===t.x&&this.y===t.y}array(){return[this.x,this.y]}copy(){return new h(this.x,this.y)}isInBounds(t,s){return this.x>=t.x&&this.x<=s.x&&this.y>=t.y&&this.y<=s.y}valueOf(){return this.array()}toString(){return this.array().toString()}}const w=document.getElementById("canvas");w.width=window.innerWidth;w.height=window.innerHeight;window.addEventListener("resize",()=>{w.width=window.innerWidth,w.height=window.innerHeight});const f=w.getContext("2d"),C=()=>new h(w.width,w.height),H=(()=>{const i=new h(0,0);return u.on("mousemove",t=>{i.set(t.clientX,t.clientY)}),()=>i.copy()})();window.addEventListener("keydown",i=>{u.emit("keydown",i)}),window.addEventListener("keyup",i=>{u.emit("keyup",i)}),window.addEventListener("mousemove",i=>{u.emit("mousemove",i)}),window.addEventListener("contextmenu",i=>{u.emit("contextmenu",i)});const T=1e-6,G=i=>i.copy().sub(...Y.array()).div(...R.copy().div(D,S).array()),b=(i,t)=>t>0?Math.ceil(i+Math.sign(t)*T):t<0?Math.floor(i+Math.sign(t)*T):i;class K{static number(t=1,s){return s||(s=t,t=0),Math.random()*(s-t+1)+t}static string(t=8,s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"){let e="";if(s instanceof Array){for(let n of s)e+=n[Math.round(this.number(0,n.length-1))];for(let n=e.length;n<t;n++){const r=this.fromArray(s);e+=r[Math.round(this.number(0,r.length-1))]}e=this.shuffle(e)}if(typeof s=="string"){const n=s.split("");for(let r=0;r<t;r++)e+=this.fromArray(n)}return e.slice(0,t)}static fromArray(t){return t[Math.round(this.number(0,t.length-1))]}static shuffle(t){return t instanceof Array?t.map(s=>s).sort(()=>this.number(-1,1)):typeof t=="string"?t.split("").sort(()=>this.number(-1,1)).join(""):t}}const W=class W{constructor(t,s){o(this,"pos");o(this,"size");this.pos=t,this.size=s,W.arrayOfGameObjects.push(this)}getPos(){return this.pos.copy()}getSize(){return this.size.copy()}};o(W,"arrayOfGameObjects",[]);let L=W;var a=(i=>(i[i.EMPTY=0]="EMPTY",i[i.WALL=1]="WALL",i))(a||{}),k=(i=>(i.EMPTY="#243a3c",i.WALL="#24282c",i))(k||{});class q extends L{constructor(s,e,n=0){super(s,e);o(this,"type");o(this,"color");this.type=n,this.color=k[a[this.type]],this.attachEvents()}attachEvents(){}draw(s){s.fillStyle=this.color,s.strokeStyle="#0003",s.lineWidth=.03,Z(s,this.pos.x,this.pos.y,this.size.x,this.size.y),s.fill(),s.stroke()}update(...s){[...s]}changeType(s){this.type=s,this.color=k[a[this.type]]}}const D=20,S=20,R=new h(C().y,C().y).sub(32),Y=new h(16,16),g=class g{constructor(t,s){o(this,"COLS");o(this,"ROWS");o(this,"map",[]);o(this,"pos",new h(0,0));o(this,"size",new h(0,0));this.COLS=t,this.ROWS=s,g.instance=this,this.attachEvents(),this.fillWorld()}attachEvents(){u.on("contextmenu",t=>{t.preventDefault();const s=g.getCell(...G(H()).floor().array());s&&s.changeType(s.type===a.EMPTY?a.WALL:a.EMPTY)})}getCell(t,s){try{return this.map[s][t]}catch{return null}}static getCell(t,s){return g.instance.getCell(t,s)}fillWorld(){for(let t=0;t<this.ROWS;t++){this.map[t]=[];for(let s=0;s<this.COLS;s++){let e=a.EMPTY;t===0||t===this.ROWS-1||s===0||s===this.COLS-1?e=a.WALL:s==1&&t==1||(e=K.fromArray([a.EMPTY,a.EMPTY,a.EMPTY,a.EMPTY,a.EMPTY,a.EMPTY,a.EMPTY,a.EMPTY,a.WALL,a.WALL])),this.map[t][s]=new q(new h(s,t),new h(1,1),e)}}}draw(t){t.fillStyle="#181818",t.rect(this.pos.x,this.pos.y,this.size.x,this.size.y),t.fill(),v(t);for(let s=0;s<this.ROWS;s++)for(let e=0;e<this.COLS;e++)this.map[s][e].draw(t);O(t)}update(){}};o(g,"instance");let d=g;const v=i=>{i.translate(...Y.array()),i.scale(...R.copy().div(D,S).array())},O=i=>{i.resetTransform()},P=(i,t,s,e,n,r=!0)=>{r&&i.beginPath(),i.moveTo(t,s),i.lineTo(e,n),r&&i.closePath()},Z=(i,t,s,e,n,r=!0)=>{r&&i.beginPath(),i.rect(t,s,e,n),r&&i.closePath()},F=(i,t,s,e,n=!0)=>{n&&i.beginPath(),i.arc(t,s,e,0,2*Math.PI),n&&i.closePath()};class z{constructor(t,s){o(this,"initialPos");o(this,"initialDir");o(this,"pos");o(this,"dir");o(this,"dots",[]);this.initialPos=t.copy(),this.initialDir=s.copy().normalize().mult(T),this.pos=this.initialPos.copy(),this.dir=this.initialDir.copy().add(this.initialPos)}next(){const t=new h(...this.dir.array()),s=this.dir.copy().sub(this.pos);if(s.x!==0){const e=s.y/s.x,n=this.pos.y-e*this.pos.x,r=b(this.dir.x,s.x),p=r*e+n;if(t.set(r,p),e!==0){const y=b(this.dir.y,s.y),l=(y-n)/e;this.dir.dist(l,y)<this.dir.dist(t)&&t.set(l,y)}}else{const e=b(this.dir.y,s.y),n=this.dir.x;t.set(n,e)}return this.dots.push(t),this.pos.set(t),this.dir.set(t).add(this.initialDir),t.add(this.initialDir.copy().mult(-2))}prev(){return this.dots[this.dots.length-2].copy()}}const A=class A extends L{constructor(s,e){super(s,e);o(this,"viewAngle",new h(1,1));o(this,"raysDots",[]);o(this,"raysDotsOnWall",[]);o(this,"FOV",90);o(this,"FOVRayCount",360);o(this,"FOVRayStep",Math.abs((-this.FOV/2-this.FOV/2)/this.FOVRayCount));o(this,"mousePos",new h(0,0));o(this,"prevMousePos",new h(0,0));o(this,"keys",{});o(this,"rotateSpeed",3);o(this,"moveSpeed",.05);o(this,"mouseSensitivity",.3);o(this,"mouseControlled",!0);A.players.push(this),this.attachEvents()}toggleMouseControl(){this.mouseControlled=!this.mouseControlled}attachEvents(){u.on("keydown",s=>{this.keys[s.key.toLowerCase()]=!0}),u.on("keyup",s=>{this.keys[s.key.toLowerCase()]=!1}),u.on("mousemove",s=>{this.prevMousePos.equals(new h)&&this.prevMousePos.set(s.clientX,s.clientY),this.mousePos.set(s.clientX,s.clientY)})}draw(s){v(s),s.fillStyle="#f0f",F(s,...this.pos.array(),this.size.x),s.fill(),s.strokeStyle="#fff",s.lineWidth=.01,P(s,...this.pos.array(),...this.pos.copy().add(this.viewAngle).array()),s.stroke(),this.drawFOV(s),O(s)}drawFOV(s){if(this.raysDotsOnWall.length>0){s.fillStyle="#0f0",s.beginPath(),P(s,...this.pos.array(),...this.raysDotsOnWall[0].array(),!1);for(let e=1;e<this.raysDotsOnWall.length;e++)P(s,...this.raysDotsOnWall[e-1].array(),...this.raysDotsOnWall[e].array(),!1);P(s,...this.raysDotsOnWall.at(-1).array(),...this.pos.array(),!1),s.closePath(),s.stroke()}}update(){var s,e,n,r,p;if((this.keys.a||this.keys.ф)&&this.viewAngle.rotateDegrees(-this.rotateSpeed),(this.keys.d||this.keys.в)&&this.viewAngle.rotateDegrees(this.rotateSpeed),this.mouseControlled&&(this.viewAngle.rotateDegrees((this.mousePos.x-this.prevMousePos.x)*this.mouseSensitivity),this.prevMousePos.set(...this.mousePos.array())),this.keys.w||this.keys.ц){const{x:y,y:l}=this.pos.copy().add(this.viewAngle.copy().mult(this.moveSpeed));((s=d.getCell(Math.floor(y),Math.floor(this.pos.y)))==null?void 0:s.type)!==a.WALL&&(this.pos.x=y),((e=d.getCell(Math.floor(this.pos.x),Math.floor(l)))==null?void 0:e.type)!==a.WALL&&(this.pos.y=l)}if(this.keys.s||this.keys.ы){const{x:y,y:l}=this.pos.copy().add(this.viewAngle.copy().rotateDegrees(180).mult(this.moveSpeed));((n=d.getCell(Math.floor(y),Math.floor(this.pos.y)))==null?void 0:n.type)!==a.WALL&&(this.pos.x=y),((r=d.getCell(Math.floor(this.pos.x),Math.floor(l)))==null?void 0:r.type)!==a.WALL&&(this.pos.y=l)}((p=d.getCell(...this.pos.copy().floor().array()))==null?void 0:p.type)==a.WALL&&this.pullOutFromWall(),this.raysDots=[],this.raysDotsOnWall=[];for(let y=-this.FOV/2;y<=this.FOV/2;y+=this.FOVRayStep){const l=new z(this.pos,this.viewAngle.copy().rotateDegrees(y));for(;;){if(this.raysDots.length+this.raysDotsOnWall.length>=Number.MAX_SAFE_INTEGER)throw new Error("Too many rays");const M=l.next();if(M.isInBounds(new h(0,0),new h(D,S))===!1)break;const m=d.getCell(...M.copy().floor().array());if(m instanceof q?m.type===a.WALL:!1){this.raysDots.at(-1)instanceof h&&this.raysDotsOnWall.push(this.raysDots.at(-1));break}this.raysDots.push(M)}}}pullOutFromWall(){var y;const s=[],e=[];for(let l=0;l<360;l+=360/36){const M=new z(this.pos,h.fromAngleDegrees(l));for(let E=0;E<10;E++){const m=M.next().add(h.fromAngle(l).div(10));((y=d.getCell(...m.copy().floor().array()))==null?void 0:y.type)===a.EMPTY&&(s.push(m),e.push(m.dist(this.pos)))}}v(f),f.fillStyle="#f00",f.beginPath();for(let l=0;l<s.length;l++)F(f,...s[l].array(),.03),f.fill();f.closePath(),O(f);const n=Math.min(...e),r=e.indexOf(n),p=s[r];this.pos.set(p)}};o(A,"players",[]);let c=A;window.Player=c;const x=new d(D,S);x.pos=Y;x.size=R;new c(new h(1.5,1.5),new h(.2));let I=0,B=0;const N=i=>{if(i){const t=i-I;I=i,B=1e3/t}f.fillStyle="#333",f.fillRect(0,0,...C().array()),x.update(),x.draw(f);for(let t=0;t<c.players.length;t++)c.players[t].update(),c.players[t].draw(f);f.font="16px monospace",f.fillStyle="#fff",f.fillText(Math.round(B).toString(),16,16),requestAnimationFrame(N)};N();
